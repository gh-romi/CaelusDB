{% extends 'main/base.html' %}

{% block title %}Vyhledat let{% endblock %}

{% block content %}

<style>

    /* --- STYLY PRO NA≈†EPTV√Åƒå --- */
    .suggestions-box {
        border: 1px solid #ccc;
        max-height: 200px;
        overflow-y: auto;
        position: absolute;
        background: white;
        z-index: 1000; /* Aby byl nad ostatn√≠m obsahem */
        width: 100%;
        border-radius: 0 0 10px 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: none; /* Defaultnƒõ skryt√© */
        top: 100%; /* Hned pod inputem */
    }

    .suggestion-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        font-size: 0.95rem;
    }

    .suggestion-item:hover {
        background-color: #f0f8ff;
        color: #0056b3;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    /* --- STYLY PRO KARTU LETU --- */
    .flight-card {
        background: white;
        border: 1px solid #ddd;
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* --- STYLY PRO ≈ò√ÅDEK LETU (Segment) --- */
    .flight-segment {
        display: flex;           /* Pou≈æijeme Flexbox pro rozdƒõlen√≠ na sloupce */
        flex-direction: row;
        align-items: baseline;   /* Zarovnat text na √∫ƒça≈ô√≠ */
        gap: 15px;               /* Mezera mezi ƒçasem a n√°zvem leti≈°tƒõ */
        margin-bottom: 8px;
    }

    /* Lev√Ω sloupec: Datum a ƒåas */
    .segment-left {
        flex: 0 0 140px;         /* Pevn√° ≈°√≠≈ôka: Datum+ƒåas zaberou v≈ædy 140px */
        display: flex;
        gap: 8px;
        white-space: nowrap;     /* Zabra≈à rozlomen√≠ data a ƒçasu na PC */
    }

    /* Prav√Ω sloupec: Leti≈°tƒõ */
    .flight-airport {
        flex: 1;                 /* Zabere zbytek m√≠sta */
        color: #333;
        font-size: 0.95rem;
        /* Pokud se text zalom√≠, z≈Østane v tomto bloku a nepoleze pod datum */
    }

    .flight-date { color: #666; font-size: 0.9rem; }
    .flight-time { font-weight: bold; font-size: 1.1rem; color: #000; }

    /* --- MOBILN√ç ZOBRAZEN√ç --- */
    @media (max-width: 768px) {
        .flight-card {
            flex-direction: column;
            align-items: flex-start;
            padding-bottom: 20px;
        }

        /* √öprava lev√©ho sloupce na mobilu */
        .segment-left {
            flex: 0 0 auto;        /* Na mobilu nefixujeme ≈°√≠≈ôku */
            flex-direction: column; /* Datum a ƒåas d√°me POD SEBE */
            gap: 0;
            margin-right: 10px;
            width: 80px;           /* Pevn√° ≈°√≠≈ôka pro zarovn√°n√≠ ƒças≈Ø pod sebou */
        }

        .flight-date { font-size: 0.8rem; } /* Men≈°√≠ datum na mobilu */

        .flight-info-right {
            width: 100%;
            text-align: left;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 0 !important;
        }

        .flight-info-right a.btn {
            margin-bottom: 5px;
        }
    }
</style>

<div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <h2 style="margin-top: 0;">Kam to bude?</h2>

    <form method="GET" action="." style="display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;">

        <div style="flex: 1 1 200px; position: relative;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Odkud:</label>

            <input type="text" id="search-odkud" class="form-control city-search"
                   placeholder="Mƒõsto, leti≈°tƒõ nebo k√≥d..." autocomplete="off"
                   value="{{ nazev_odkud|default:'' }}"
                   style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 10px; box-sizing: border-box;">

            <input type="hidden" name="odkud" id="id-odkud" value="{{ request.GET.odkud }}">

            <div id="suggestions-odkud" class="suggestions-box"></div>
        </div>

        <div style="flex: 1 1 200px; position: relative;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Kam:</label>

            <input type="text" id="search-kam" class="form-control city-search"
                   placeholder="Mƒõsto, leti≈°tƒõ nebo k√≥d..." autocomplete="off"
                   value="{{ nazev_kam|default:'' }}"
                   style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 10px; box-sizing: border-box;">

            <input type="hidden" name="kam" id="id-kam" value="{{ request.GET.kam }}">

            <div id="suggestions-kam" class="suggestions-box"></div>
        </div>

        <div style="flex: 1 1 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Datum:</label>
            <input type="date" name="datum"
                   value="{{ request.GET.datum }}"
                   min="{% now 'Y-m-d' %}"
                   style="width: 100%; padding: 9px; border: 1px solid #ccc; border-radius: 10px; box-sizing: border-box; font-family: inherit;">
        </div>

        <div style="flex: 1 1 150px;">
            <button type="submit" class="btn btn-primary" style="width: 100%; height: 42px; border-radius: 10px; cursor: pointer;">Vyhledat lety</button>
        </div>
    </form>
</div>

<hr style="margin: 30px 0; border: 0; border-top: 1px solid #ddd;">

{% if cesty %}
    <h3>Nalezen√© lety:</h3>

    {% for cesta in cesty %}
        <div class="flight-card">
            <div style="flex: 2;">

                {% if cesta.pocet_prestupu == 0 %}
                    {% with let=cesta.prvni_let %}

                    <div class="flight-segment">
                        <div class="segment-left">
                            <span class="flight-date">{{ let.cas_odletu|date:"d.m.Y" }}</span>
                            <span class="flight-time">{{ let.cas_odletu|date:"H:i" }}</span>
                        </div>
                        <div class="flight-airport">
                            <strong>{{ let.id_letiste_odletu.nazev_letiste }} ({{ let.id_letiste_odletu.kod_iata }})</strong>
                        </div>
                    </div>

                    <div class="flight-segment">
                        <div class="segment-left">
                            <span class="flight-date">{{ let.cas_priletu|date:"d.m.Y" }}</span>
                            <span class="flight-time">{{ let.cas_priletu|date:"H:i" }}</span>
                        </div>
                        <div class="flight-airport">
                            <strong>{{ let.id_letiste_priletu.nazev_letiste }} ({{ let.id_letiste_priletu.kod_iata }})</strong>
                        </div>
                    </div>

                    <div class="flight-meta" style="margin-top: 10px; border-top: 1px dashed #eee; padding-top: 5px;">
                        P≈ô√≠m√Ω let ‚Ä¢ {{ let.id_aerolinky.nazev }} ‚Ä¢ {{ let.cislo_letu }}
                    </div>
                    {% endwith %}

                {% else %}
                    {% with let1=cesta.segmenty.0 let2=cesta.segmenty.1 %}

                    <div class="flight-segment">
                        <div class="segment-left">
                            <span class="flight-date">{{ let1.cas_odletu|date:"d.m.Y" }}</span>
                            <span class="flight-time">{{ let1.cas_odletu|date:"H:i" }}</span>
                        </div>
                        <div class="flight-airport">
                            <strong>{{ let1.id_letiste_odletu.nazev_letiste }} ({{ let1.id_letiste_odletu.kod_iata }})</strong>
                        </div>
                    </div>

                    <div style="margin: 5px 0; padding-left: 20px; border-left: 3px solid #d9534f; color: #666; font-size: 0.9rem; margin-left: 40px;">
                        <div style="font-weight: bold; color: #d9534f;">
                            ‚ö° P≈ôestup: {{ let1.id_letiste_priletu.mesto }} ({{ let1.id_letiste_priletu.kod_iata }})
                        </div>
                        <div>ƒåek√°n√≠: {{ let1.cas_priletu|timesince:let2.cas_odletu }}</div>
                    </div>

                    <div class="flight-segment">
                        <div class="segment-left">
                            <span class="flight-date">{{ let2.cas_priletu|date:"d.m.Y" }}</span>
                            <span class="flight-time">{{ let2.cas_priletu|date:"H:i" }}</span>
                        </div>
                        <div class="flight-airport">
                             <strong>{{ let2.id_letiste_priletu.nazev_letiste }} ({{ let2.id_letiste_priletu.kod_iata }})</strong>
                        </div>
                    </div>

                    <div class="flight-meta" style="margin-top: 10px; border-top: 1px dashed #eee; padding-top: 5px;">
                        1 p≈ôestup ‚Ä¢ {{ let1.id_aerolinky.nazev }} + {{ let2.id_aerolinky.nazev }}
                    </div>
                    {% endwith %}
                {% endif %}

            </div>

            <div class="flight-info-right" style="text-align: right; flex: 1; padding-left: 20px;">
                <div>
                    <div style="font-size: 0.9rem; color: #888; font-weight: bold;">Celkem od</div>
                    <div class="flight-price" style="font-size: 1.4rem; font-weight: bold; {% if not cesta.je_vyprodano %}color: #28a745;{% else %}color: #dc3545;{% endif %}">
                        {% if not cesta.je_vyprodano %}
                            {{ cesta.celkova_cena }} $
                        {% else %}
                            VYPROD√ÅNO
                        {% endif %}
                    </div>
                </div>

                {% if not cesta.je_vyprodano %}
                    <a href="{% url 'rezervace_detail' cesta.url_ids %}" class="btn btn-success" style="margin-top: 15px; white-space: nowrap; border-radius: 10px;">
                        Vybrat let ‚ûî
                    </a>
                {% else %}
                     <button class="btn" style="margin-top: 15px; white-space: nowrap; border-radius: 10px; background: #eee; color: #999; cursor: not-allowed;" disabled>
                        Nelze rezervovat
                     </button>
                {% endif %}
            </div>
        </div>
    {% endfor %}


{% if cesty.has_other_pages %}
    <div style="margin-top: 30px; text-align: center; padding-bottom: 20px;">
        <div class="pagination">

            {% if cesty.has_previous %}
                <a href="?page={{ cesty.previous_page_number }}{% if request.GET.odkud %}&odkud={{ request.GET.odkud }}{% endif %}{% if request.GET.kam %}&kam={{ request.GET.kam }}{% endif %}{% if request.GET.datum %}&datum={{ request.GET.datum }}{% endif %}" class="btn" style="background: #eee; color: #333; margin-right: 10px; border-radius: 10px;">
                    &laquo; P≈ôedchoz√≠
                </a>
            {% endif %}

            <span style="font-weight: bold; color: #666; margin: 0 10px;">
                Strana {{ cesty.number }} z {{ cesty.paginator.num_pages }}
            </span>

            {% if cesty.has_next %}
                <a href="?page={{ cesty.next_page_number }}{% if request.GET.odkud %}&odkud={{ request.GET.odkud }}{% endif %}{% if request.GET.kam %}&kam={{ request.GET.kam }}{% endif %}{% if request.GET.datum %}&datum={{ request.GET.datum }}{% endif %}" class="btn" style="background: #eee; color: #333; margin-left: 10px; border-radius: 10px;">
                    Dal≈°√≠ &raquo;
                </a>
            {% endif %}

        </div>
    </div>
{% endif %}

{% elif je_vyhledavani %}
    <div style="text-align: center; padding: 50px; color: #666;">
        <div style="font-size: 3rem; margin-bottom: 10px;">‚úàÔ∏è‚ùì</div>
        <h3>≈Ω√°dn√© lety nenalezeny</h3>
        <p>Zkuste zmƒõnit datum nebo vybrat jin√° leti≈°tƒõ.</p>
    </div>

{% else %}
    <div style="text-align: center; padding: 60px 20px; color: #444;">
        <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.8;">üåç</div>
        <h1 style="margin-bottom: 10px;">V√≠tejte v CaelusDB</h1>
        <p style="font-size: 1.2rem; color: #666;">
            Vyberte si destinaci a vydejte se na cestu.
        </p>
    </div>

{% endif %}


<script>
    // P≈ôevedeme Django list leti≈°≈• na JavaScript pole
    const LETISTE_DATA = [
        {% for l in letiste_list %}
        {
            id: "{{ l.id }}",
            // P≈òID√ÅN FILTR |escapejs KE V≈†EM POLO≈ΩK√ÅM
            nazev: "{{ l.nazev_letiste|escapejs }}",
            iata: "{{ l.kod_iata|escapejs }}",
            mesto: "{{ l.mesto|escapejs }}",
            zeme: "{{ l.zeme|escapejs }}",

            // I zde mus√≠me pou≈æ√≠t escapejs pro ka≈ædou promƒõnnou zvl√°≈°≈•
            displayValue: "{{ l.mesto|escapejs }} ({{ l.kod_iata|escapejs }}), {{ l.zeme|escapejs }}",
            listValue: "{{ l.nazev_letiste|escapejs }} ({{ l.kod_iata|escapejs }}), {{ l.mesto|escapejs }}, {{ l.zeme|escapejs }}"
        },
        {% endfor %}
    ];
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {

        // Funkce pro inicializaci jednoho na≈°ept√°vaƒçe
        function setupAutocomplete(inputId, hiddenId, boxId) {
            const input = document.getElementById(inputId);
            const hidden = document.getElementById(hiddenId);
            const box = document.getElementById(boxId);

            // Pokud inputy neexistuj√≠, konƒç√≠me
            if (!input || !hidden || !box) return;

            // Event: Psan√≠ do inputu
            input.addEventListener('input', function() {
                const val = this.value.toLowerCase();
                box.innerHTML = ''; // Vyƒçistit star√© v√Ωsledky

                if (val.length < 2) {
                    box.style.display = 'none';
                    return;
                }

                // Filtrace (hled√°me v n√°zvu, mƒõstƒõ, IATA k√≥du nebo zemi)
                const matches = LETISTE_DATA.filter(l =>
                    l.nazev.toLowerCase().includes(val) ||
                    l.mesto.toLowerCase().includes(val) ||
                    l.iata.toLowerCase().includes(val) ||
                    l.zeme.toLowerCase().includes(val)
                );

                if (matches.length > 0) {
                    box.style.display = 'block';
                    matches.forEach(l => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerText = l.listValue; // Form√°t pro seznam

                        // Kliknut√≠ na polo≈æku
                        div.addEventListener('click', function() {
                            input.value = l.displayValue; // Form√°t pro input
                            hidden.value = l.id;          // ID pro server
                            box.style.display = 'none';
                        });
                        box.appendChild(div);
                    });
                } else {
                    box.style.display = 'none';
                }
            });

            // Event: Kliknut√≠ mimo zav≈ôe na≈°ept√°vaƒç
            document.addEventListener('click', function(e) {
                if (e.target !== input) {
                    box.style.display = 'none';
                }
            });

            // Event: Pokud u≈æivatel sma≈æe text, vyma≈æeme i ID
            input.addEventListener('change', function() {
                if (this.value === '') {
                    hidden.value = '';
                }
            });
        }

        // Spust√≠me pro oba inputy
        setupAutocomplete('search-odkud', 'id-odkud', 'suggestions-odkud');
        setupAutocomplete('search-kam', 'id-kam', 'suggestions-kam');
    });
</script>

{% endblock %}