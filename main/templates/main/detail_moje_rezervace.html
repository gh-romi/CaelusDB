{% extends 'main/base.html' %}

{% block title %}Detail rezervace #{{ rezervace.id }}{% endblock %}

{% block content %}

<div style="max-width: 800px; margin: 0 auto;">

    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <h1 style="margin: 0;">Rezervace #{{ rezervace.id }}</h1>
        <a href="{% url 'moje_rezervace' %}" class="btn" style="background-color: #6c757d; color: white; text-decoration: none;">
            ü†î Zpƒõt
        </a>
    </div>

    <div style="background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px;">

        <div class="info-header" style="display: flex; flex-wrap: wrap; gap: 30px; justify-content: space-between; align-items: center;">

            <div class="info-item">
                <div style="color: #666; font-size: 0.9rem;">Vytvo≈ôeno</div>
                <div style="font-weight: bold;">{{ rezervace.datum_rezervace|date:"d.m.Y H:i" }}</div>
            </div>

            <div class="info-item" style="text-align: center">
                <div style="color: #666; font-size: 0.9rem;">Stav</div>
                {% if rezervace.status_platby == 'ZAPLACENO' %}
                    <span style="color: #28a745; font-weight: bold; font-size: 1.1rem;">Zaplaceno</span>
                {% else %}
                    <span style="color: #dc3545; font-weight: bold; font-size: 1.1rem;">Nezaplaceno ‚ùå</span>
                {% endif %}
            </div>

            <div class="info-item">
                <div style="color: #666; font-size: 0.9rem;">Celkov√° cena</div>
                <div style="font-weight: bold; font-size: 1.5rem; color: #28a745;">{{ rezervace.celkova_cena }} $</div>
            </div>

        </div>

        {% if rezervace.status_platby == 'NEZAPLACENO' %}
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <div class="timer-container" data-created="{{ rezervace.datum_rezervace|date:'U' }}" style="background: #fff5f5; padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                Zb√Ωv√° ƒçasu na zaplacen√≠: <span class="countdown" style="font-weight: bold; color: #d9534f;">--:--</span>
            </div>

            <div class="action-buttons">
                <form id="delete-form" method="POST" action="{% url 'smazat_rezervaci' rezervace.id %}" class="delete-form">
                    {% csrf_token %}
                    <button type="button" onclick="openDeleteModal()" class="btn btn-delete">
                        Odstranit
                    </button>
                </form>

                <a href="{% url 'platba' rezervace.id %}" class="btn btn-success btn-pay">
                    P≈ôej√≠t k platbƒõ
                </a>
            </div>
        {% endif %}

        </div>

    <h3 style="margin-bottom: 15px;">Letenky</h3>

    {% for letenka in rezervace.letenky_set.all %}
        <div class="flight-card">
            <div style="flex: 1;">
                <div class="route-header">
                    <div class="route-city">
                        {{ letenka.id_letu.id_letiste_odletu.mesto }}
                        ({{ letenka.id_letu.id_letiste_odletu.kod_iata }}),
                        {{ letenka.id_letu.id_letiste_odletu.zeme }}
                    </div>
                    <div class="route-arrow">‚ûù</div>
                    <div class="route-city">
                        {{ letenka.id_letu.id_letiste_priletu.mesto }}
                        ({{ letenka.id_letu.id_letiste_priletu.kod_iata }}),
                        {{ letenka.id_letu.id_letiste_priletu.zeme }}
                    </div>
                </div>

                <div style="margin-top: 10px; color: #555;">
                    <div>üìÖ <strong>{{ letenka.id_letu.cas_odletu|date:"d.m.Y" }}</strong></div>
                    <div>üïí {{ letenka.id_letu.cas_odletu|date:"H:i" }} - {{ letenka.id_letu.cas_priletu|date:"H:i" }}</div>
                    <div style="margin-top: 5px; font-size: 0.9rem;">
                        Letadlo: {{ letenka.id_letu.id_letadla.model }} ({{ letenka.id_letu.id_aerolinky.nazev }})
                    </div>
                </div>
            </div>

            <div class="flight-info-right">
                <div class="seat-price-row">
                    <div class="seat-info">
                        <div style="font-size: 0.9rem; color: #888;">T≈ô√≠da / Sedadlo</div>
                        <div style="font-weight: bold;">{{ letenka.id_tridy.nazev_tridy }}</div>
                        <div style="font-size: 1.2rem; color: #0056b3;">{{ letenka.cislo_sedadla }}</div>
                    </div>

                    <div class="price-info">
                        <span style="color: #28a745; font-size: 1.3rem; font-weight: bold;">{{ letenka.cena_letenky }} $</span>
                    </div>
                </div>

                <div class="ticket-actions">

                    {% if rezervace.status_platby == 'NEZAPLACENO' %}
                        <a href="{% url 'upravit_letenku' letenka.id %}" class="btn btn-primary change-btn">
                            Zmƒõnit t≈ô√≠du/sedadlo
                        </a>

                    {% elif rezervace.status_platby == 'ZAPLACENO' %}
                        <a href="{% url 'zmenit_sedadlo' letenka.id %}" class="btn btn-primary change-btn"
                           style="background-color: #6c757d; color: white; text-decoration: none;">
                            Zmƒõnit sedadlo
                        </a>

                        <button onclick="openQR('{{ letenka.id }}', '{{ letenka.id_letu.cislo_letu }}', '{{ letenka.cislo_sedadla }}', '{{ user.email }}')"
                                class="btn btn-primary change-btn">
                            QR k√≥d
                        </button>
                    {% endif %}

                </div>
            </div>
        </div>
    {% endfor %}

</div>

<div id="qr-modal" class="modal-overlay" onclick="closeQR()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 style="margin-top: 0; color: #003366;">Palubn√≠ l√≠stek</h2>
        <p style="color: #666;">Letenka #<span id="qr-ticket-id"></span></p>
        <img id="qr-image" src="" alt="QR K√≥d" style="width: 200px; height: 200px; margin: 10px 0;">
        <p style="font-size: 0.9rem; color: #888;">Uka≈æte tento k√≥d p≈ôi n√°stupu.</p>
        <button onclick="closeQR()" class="btn btn-primary" style="width: 100%; margin-top: 10px; border-radius: 10px;">Zav≈ô√≠t</button>
    </div>
</div>

<div id="delete-modal" class="modal-overlay" onclick="closeDeleteModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="font-size: 3rem; margin-bottom: 10px;">‚ö†Ô∏è</div>

        <h2 style="margin-top: 0; color: #333;">Smazat rezervaci?</h2>
        <p style="color: #666; margin-bottom: 25px;">Tato akce je nevratn√°. Opravdu chcete pokraƒçovat?</p>

        <div style="display: flex; gap: 10px;">
            <button onclick="closeDeleteModal()" class="btn" style="flex: 1; background-color: #eee; color: #333; border-radius: 10px;">
                Ne
            </button>

            <button onclick="confirmDelete()" class="btn" style="flex: 1; background-color: #dc3545; color: white; border-radius: 10px;">
                Ano
            </button>
        </div>
    </div>
</div>

<style>
    /* --- STYLY PRO TLAƒå√çTKA (DESKTOP) --- */
    .action-buttons {
        display: flex;
        gap: 15px;
        width: 100%;
    }

    /* Formul√°≈ô pro smaz√°n√≠ zabere 1 d√≠l (1/3) */
    .delete-form {
        flex: 1;
    }
    .btn-delete {
        width: 100%;
        background-color: #dc3545;
        color: white;
        padding: 15px;
        border-radius: 10px;
        border: none;
        font-size: 1.1rem;
        height: 54px;
        cursor: pointer;
        white-space: nowrap;
    }

    /* Tlaƒç√≠tko platby zabere 2 d√≠ly (2/3) */
    .btn-pay {
        flex: 2;
        text-align: center;
        padding: 15px;
        font-size: 1.1rem;
        border-radius: 10px;
        box-sizing: border-box;
        text-decoration: none;
        height: 54px;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
    }

    /* --- Ostatn√≠ styly --- */
    .flight-card { background: white; border: 1px solid #ddd; padding: 20px; margin-bottom: 15px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; }
    .route-header { color: #003366; font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .route-arrow { color: #888; font-weight: normal; }

    .flight-info-right { text-align: right; }
    .price-info { margin-top: 10px; }
    .ticket-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; }
    .change-btn, .qr-btn { padding: 8px 15px; font-size: 0.9rem; border-radius: 5px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap; }

    /* --- Modal --- */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
    .modal-content { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.3s ease; }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }


    /* --- MOBILN√ç √öPRAVY --- */
    @media (max-width: 768px) {
        /* 1. Tlaƒç√≠tka: Otoƒçit po≈ôad√≠ a pod sebe */
        .action-buttons {
            flex-direction: column-reverse; /* Zaplatit bude naho≈ôe */
            gap: 10px;
        }
        .delete-form, .btn-pay {
            flex: auto; /* Zru≈°√≠me pomƒõr 1:2 */
            width: 100%; /* Rozt√°hneme na celou ≈°√≠≈ôku */
        }

        /* 2. Info karta */
        .info-header { flex-direction: column; align-items: stretch !important; gap: 0 !important; }
        .info-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .info-item:last-child { border-bottom: none; }

        /* 3. Letenky */
        .flight-card { flex-direction: column; align-items: flex-start; }
        .route-header { flex-direction: column; align-items: flex-start; gap: 5px; }
        .route-arrow { transform: rotate(90deg); margin-left: 5px; display: none; }

        /* Prav√° ƒç√°st letenky */
        .flight-info-right { width: 100%; display: flex; flex-direction: column; margin-top: 15px; border-top: 1px dashed #eee; padding-top: 15px; text-align: left !important; align-items: flex-start; }

        .seat-price-row { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; margin-bottom: 15px; }
        .seat-info { text-align: left; }
        .price-info { text-align: right; margin-top: 0; }

        .ticket-actions { width: 100%; flex-direction: column; gap: 10px; }
        .change-btn, .qr-btn { width: 100%; box-sizing: border-box; height: 45px; }
    }
</style>

<script>
    // Funkce pro otev≈ôen√≠ QR popupu
    function openQR(ticketId, flightCode, seatNumber, userEmail) {
        const modal = document.getElementById('qr-modal');
        const qrImage = document.getElementById('qr-image');
        const ticketIdSpan = document.getElementById('qr-ticket-id');

        // Nastav√≠me text
        ticketIdSpan.innerText = ticketId;

        // Vygenerujeme data pro QR k√≥d (kombinace ID, letu a emailu)
        const qrData = `TICKET:${ticketId}|FLIGHT:${flightCode}|SEAT:${seatNumber}|USER:${userEmail}`;

        // Pou≈æijeme ve≈ôejnou API pro generov√°n√≠ QR k√≥du
        qrImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}`;

        // Zobraz√≠me modal (pou≈æijeme flex pro centrov√°n√≠)
        modal.style.display = 'flex';
    }

    // Funkce pro zav≈ôen√≠
    function closeQR() {
        document.getElementById('qr-modal').style.display = 'none';
    }

    // Timer (jen pro nezaplacen√©)
    {% if rezervace.status_platby == 'NEZAPLACENO' %}
    function updateTimers() {
        const now = Math.floor(Date.now() / 1000);
        const timers = document.querySelectorAll('.timer-container');
        timers.forEach(timer => {
            const createdTimestamp = parseInt(timer.getAttribute('data-created'));
            const expireTimestamp = createdTimestamp + (30 * 60);
            const diff = expireTimestamp - now;

            if (diff <= 0) {
                window.location.href = "{% url 'moje_rezervace' %}?expired=1";
            } else {
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                const display = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                timer.querySelector('.countdown').innerText = display;
            }
        });
    }
    updateTimers();
    setInterval(updateTimers, 1000);
    {% endif %}

    // --- Funkce pro Maz√°n√≠ ---
    function openDeleteModal() {
        document.getElementById('delete-modal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('delete-modal').style.display = 'none';
    }

    function confirmDelete() {
        // Najdeme formul√°≈ô a ode≈°leme ho
        document.getElementById('delete-form').submit();
    }
</script>

{% endblock %}
