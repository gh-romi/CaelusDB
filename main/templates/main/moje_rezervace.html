{% extends 'main/base.html' %}

{% block title %}Moje rezervace{% endblock %}

{% block content %}

<div style="max-width: 800px; margin: 0 auto;">

    <h1 style="margin-bottom: 20px;"> üé´ Moje rezervace</h1>

    <div style="background: white; padding: 20px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
        <form method="GET" action="." style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end;">

            <div style="flex: 1 1 100%; margin-bottom: 10px;">
                <label style="cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" name="zobrazit_vse" {% if zobrazit_vse %}checked{% endif %}
                           onchange="toggleDateInputs(this)">
                    Zobrazit i probƒõhl√© lety (historii)
                </label>
            </div>

            <div style="flex: 1 1 150px;">
                <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Datum od:</label>
                <input type="date" id="input-datum-od" name="datum_od" value="{{ request.GET.datum_od }}" class="form-control">
            </div>

            <div style="flex: 1 1 150px;">
                <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Datum do:</label>
                <input type="date" name="datum_do" value="{{ request.GET.datum_do }}" class="form-control">
            </div>

            <div style="flex: 1 1 100px;">
                <button type="submit" class="btn btn-primary" style="width: 100%; height: 38px; border-radius: 10px;">
                    Filtrovat
                </button>
            </div>
        </form>
    </div>

    {% if rezervace_list %}
        {% for rezervace in rezervace_list %}
            <div class="reservation-card">

                <div style="flex: 1;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #003366;">
                            Rezervace #{{ rezervace.id }}
                            <a style="color: #666; font-size: 0.9rem;">  ({{ rezervace.datum_rezervace|date:"d.m.Y H:i" }}) </a>
                        </div>

                    </div>

                    {% with letenky=rezervace.letenky_set.all %}
                        {% if letenky %}
                            <div class="route-header">
                                <div class="route-city">
                                    {{ letenky.first.id_letu.id_letiste_odletu.mesto }}
                                    ({{ letenky.first.id_letu.id_letiste_odletu.kod_iata }})
                                </div>

                                <div class="route-arrow">‚ûù</div>

                                <div class="route-city">
                                    {{ letenky.last.id_letu.id_letiste_priletu.mesto }}
                                    ({{ letenky.last.id_letu.id_letiste_priletu.kod_iata }})
                                </div>
                            </div>

                            <div style="color: #555; font-size: 0.95rem; margin-bottom: 10px;">
                                üìÖ <strong>{{ letenky.first.id_letu.cas_odletu|date:"d.m.Y" }}</strong>
                                ‚Ä¢ üïí {{ letenky.first.id_letu.cas_odletu|date:"H:i" }}
                                {% if letenky.count > 1 %}
                                    <span style="color: #d9534f; font-weight: bold; margin-left: 5px;">
                                        ({{ letenky.count|add:"-1" }} p≈ôestup)
                                    </span>
                                {% endif %}
                            </div>
                        {% else %}
                            <div style="color: red;">Chyba: ≈Ω√°dn√© letenky</div>
                        {% endif %}
                    {% endwith %}
                    <div>
                        Stav:
                        {% if rezervace.status_platby == 'ZAPLACENO' %}
                            <span style="color: #28a745; font-weight: bold;">Zaplaceno ‚úÖ</span>
                        {% else %}
                            <span style="color: #dc3545; font-weight: bold;">Nezaplaceno ‚ùå</span>
                            <div class="timer-container" data-created="{{ rezervace.datum_rezervace|date:'U' }}">
                                Zb√Ωv√° ƒçasu: <span class="countdown" style="font-weight: bold; color: #d9534f;">--:--</span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="reservation-right">
                    <div style="font-size: 1.3rem; font-weight: bold; color: #28a745; margin-bottom: 10px;">
                        {{ rezervace.celkova_cena }} $
                    </div>

                    <a href="{% url 'detail_moje_rezervace' rezervace.id %}" class="btn btn-primary" style="font-size: 0.9rem; border-radius: 10px; padding: 8px 15px;">
                        Podrobnosti ‚ûî
                    </a>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p style="text-align: center; color: #666; margin-top: 50px;">
            ≈Ω√°dn√© rezervace nenalezeny.
        </p>
    {% endif %}

</div>

<div id="expiry-popup" class="custom-alert" style="cursor: pointer; background-color: #dc3545;">
    ‚è≥ ƒåas na zaplacen√≠ rezervace vypr≈°el.<br>
    <span style="font-weight: normal; font-size: 0.9rem;">(Kliknut√≠m zav≈ôete)</span>
</div>



{% if rezervace_list.has_other_pages %}
    <div style="margin-top: 30px; text-align: center;">
        <div class="pagination">

            {% if rezervace_list.has_previous %}
                <a href="?page={{ rezervace_list.previous_page_number }}{% if request.GET.zobrazit_vse %}&zobrazit_vse=on{% endif %}{% if request.GET.datum_od %}&datum_od={{ request.GET.datum_od }}{% endif %}{% if request.GET.datum_do %}&datum_do={{ request.GET.datum_do }}{% endif %}" class="btn" style="background: #eee; color: #333; margin-right: 10px;">
                    &laquo; P≈ôedchoz√≠
                </a>
            {% endif %}

            <span style="font-weight: bold; color: #666;">
                Strana {{ rezervace_list.number }} z {{ rezervace_list.paginator.num_pages }}
            </span>

            {% if rezervace_list.has_next %}
                <a href="?page={{ rezervace_list.next_page_number }}{% if request.GET.zobrazit_vse %}&zobrazit_vse=on{% endif %}{% if request.GET.datum_od %}&datum_od={{ request.GET.datum_od }}{% endif %}{% if request.GET.datum_do %}&datum_do={{ request.GET.datum_do }}{% endif %}" class="btn" style="background: #eee; color: #333; margin-left: 10px;">
                    Dal≈°√≠ &raquo;
                </a>
            {% endif %}

        </div>
    </div>
{% endif %}


<style>
    .form-control { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 10px; box-sizing: border-box; }

    .reservation-card {
        background: white;
        padding: 20px;
        border-radius: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid #eee;
        display: flex;
        justify-content: space-between;
    }

    .reservation-right {
        text-align: right;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-end;
        min-width: 120px; /* Aby se cena nel√°mala */
        margin-left: 15px;
        border-left: 1px dashed #eee;
        padding-left: 15px;
    }

    .timer-container {
        margin-top: 5px; font-size: 0.9rem; background: #fff5f5; padding: 5px; border-radius: 5px; display: inline-block;
    }

    /* --- Styly pro trasu --- */
    .route-header {
        color: #003366; font-size: 1.1rem; font-weight: bold; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 5px;
    }
    .route-arrow { color: #888; font-weight: normal; }

    /* MOBILN√ç ZOBRAZEN√ç */
    @media (max-width: 600px) {
        .reservation-card {
            flex-direction: column;
            gap: 15px;
        }

        /* Zarovn√°n√≠ prav√© ƒç√°sti (ceny a tlaƒç√≠tka) doleva */
        .reservation-right {
            text-align: left;
            align-items: center;
            border-left: none;
            border-top: 1px dashed #eee;
            padding-left: 0;
            padding-top: 15px;
            flex-direction: row;
            width: 100%;
            margin-left: 0;
        }

        .reservation-right > div {
            margin-bottom: 0;
            margin-right: auto;
        }

        /* Responzivn√≠ trasa na mobilu */
        .route-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }
        .route-arrow {
            transform: rotate(90deg);
            margin-left: 5px;
            display: none; /* Na mobilu ≈°ipku skryjeme pro ƒçist≈°√≠ vzhled, nebo nech√°me */
        }
    }
</style>

<script>
    function toggleDateInputs(checkbox) {
        const inputOd = document.getElementById('input-datum-od');

        // Z√≠sk√°me dne≈°n√≠ datum ve form√°tu YYYY-MM-DD
        const today = new Date().toISOString().split("T")[0];

        if (checkbox.checked) {
            // Pokud chce historii -> Zru≈°√≠me omezen√≠, m≈Ø≈æe vybrat cokoliv
            inputOd.removeAttribute('min');
        } else {
            // Pokud nechce historii -> Nastav√≠me minimum na dne≈°ek
            inputOd.min = today;

            // Pokud tam u≈æ m√° vybran√© star√© datum, vyma≈æeme ho, aby to nebylo matouc√≠
            if (inputOd.value && inputOd.value < today) {
                inputOd.value = today;
            }
        }
    }

    // Spustit hned po naƒçten√≠
    document.addEventListener("DOMContentLoaded", function() {
        // Popup logika (z≈Øst√°v√° stejn√°)
        // Zkontroluje URL, jestli neobsahuje ?expired=1
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('expired')) {
            const popup = document.getElementById("expiry-popup");
            if(popup) {
                popup.classList.add("show");
                popup.onclick = function() {
                    popup.classList.remove("show");
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                };
            }
        }

        // Inicializace filtru data
        const checkbox = document.querySelector('input[name="zobrazit_vse"]');
        if(checkbox) toggleDateInputs(checkbox);
    });

    function updateTimers() {
        const now = Math.floor(Date.now() / 1000);
        const timers = document.querySelectorAll('.timer-container');
        timers.forEach(timer => {
            const createdTimestamp = parseInt(timer.getAttribute('data-created'));
            const expireTimestamp = createdTimestamp + (30 * 60);
            const diff = expireTimestamp - now;
            if (diff <= 0) { location.reload(); }
            else {
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                const display = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                timer.querySelector('.countdown').innerText = display;
            }
        });
    }
    updateTimers();
    setInterval(updateTimers, 1000);
</script>

{% endblock %}
