{% extends 'main/base.html' %}

{% block title %}V√Ωbƒõr letenky{% endblock %}

{% block content %}

<div style="max-width: 800px; margin: 0 auto;">

    <h1 style="margin-bottom: 20px;">Konfigurace cesty</h1>

    <form method="POST" action="#" id="reservation-form">
        {% csrf_token %}

        {% for segment in segmenty %}

            <div class="flight-segment-container"
                 data-let-id="{{ segment.let.id }}"
                 data-occupied="{{ segment.obsazena_sedadla_json }}"
                 data-capacity="{{ segment.kapacita }}">

                <div style="background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px;">

                    <div class="route-header">
                        <div class="route-city">
                            {{ segment.let.id_letiste_odletu.mesto }}
                            ({{ segment.let.id_letiste_odletu.kod_iata }}),
                            {{ segment.let.id_letiste_odletu.zeme }}
                        </div>
                        <div class="route-arrow">‚ûù</div>
                        <div class="route-city">
                            {{ segment.let.id_letiste_priletu.mesto }}
                            ({{ segment.let.id_letiste_priletu.kod_iata }}),
                            {{ segment.let.id_letiste_priletu.zeme }}
                        </div>
                    </div>

                    <div style="margin-bottom: 20px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div>üìÖ <strong>{{ segment.let.cas_odletu|date:"d.m.Y" }}</strong></div>
                            <div>üïí {{ segment.let.cas_odletu|date:"H:i" }} - {{ segment.let.cas_priletu|date:"H:i" }}</div>
                            <div>‚úàÔ∏è {{ segment.let.id_aerolinky.nazev }} ({{ segment.let.id_letadla.model }})</div>
                        </div>
                    </div>

                    <h3>Vyberte t≈ô√≠du:</h3>

                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        {% for polozka in segment.inventar_list %}
                        <label class="option-card">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="radio"
                                       name="inventar_{{ segment.let.id }}"
                                       value="{{ polozka.id }}"
                                       data-price="{{ polozka.cena }}"
                                       data-class-index="{{ forloop.counter }}"
                                       data-seat-count="{{ polozka.pocet_mist_k_prodeji }}"
                                       required
                                       onchange="aktualizovatSedadlaAndCenu(this)">

                                <div>
                                    <strong style="font-size: 1.1rem;">{{ polozka.id_tridy.nazev_tridy }}</strong>
                                    {% if polozka.id_tridy.popis %}
                                        <br><small style="color: #777;">{{ polozka.id_tridy.popis }}</small>
                                    {% endif %}
                                </div>
                            </div>

                            <div style="font-size: 1.3rem; font-weight: bold; color: #28a745;">
                                {{ polozka.cena }} $
                            </div>
                        </label>
                        {% empty %}
                            <p style="color: red;">Bohu≈æel, pro tento let nejsou k dispozici ≈æ√°dn√° m√≠sta.</p>
                        {% endfor %}
                    </div>

                    <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                        <h3 style="margin-top: 0;">Vyberte sedadlo:</h3>

                        <select name="sedadlo_{{ segment.let.id }}"
                                id="sedadlo-select-{{ segment.let.id }}"
                                class="form-control"
                                style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 10px;"
                                required
                                disabled>
                            <option value="">-- Nejd≈ô√≠ve vyberte t≈ô√≠du --</option>
                        </select>
                    </div>

                </div>
            </div>

        {% endfor %}

        <div class="total-bar">
            <div>
                <strong>Celkem:</strong>
                <span id="total-price" style="font-size: 1.3rem; font-weight: bold; color: #11d93f;">0</span>
                <a style="font-size: 1.3rem; font-weight: bold; color: #11d93f;"> $ </a>
            </div>

            {% if user.is_authenticated %}
                <button type="submit" class="btn btn-success" style="font-size: 1.1rem; border-radius: 10px; padding: 10px 30px;">
                    Rezervovat ‚ûî
                </button>
            {% else %}
                <button type="button"
                        class="btn btn-success disabled-link"
                        style="font-size: 1.1rem; border-radius: 10px; padding: 10px 30px;"
                        onclick="showLoginAlert(event)">
                    Rezervovat ‚ûî
                </button>
            {% endif %}
        </div>

    </form>
</div>

<style>
    /* Styly (z≈Øst√°vaj√≠ stejn√© jako minule) */
    .route-header { margin-top: 0; padding-bottom: 10px; color: #003366; font-size: 1.3rem; font-weight: bold; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
    .route-arrow { color: #888; font-weight: normal; }
    .option-card { border: 2px solid #eee; padding: 15px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
    .option-card:has(input:checked) { border-color: #0056b3; background-color: #f0f8ff; }
    .total-bar { position: sticky; bottom: 70px; background: #003366; color: white; padding: 15px 30px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); margin-top: 40px; z-index: 100; }

    @media (max-width: 768px) {
        .route-header { flex-direction: column; align-items: flex-start; gap: 5px; }
        .route-arrow { transform: rotate(90deg); margin-left: 10px; }
        .total-bar { border-radius: 0; bottom: 50px; width: 100%; left: 0; margin: 0; padding: 15px; box-sizing: border-box; position: fixed; }
        form { margin-bottom: 80px; }
    }

    /* Styl pro obsazen√° sedadla v roletce */
    option:disabled {
        color: red;
        background-color: #ffe6e6;
    }
    /* Styl pro voln√° sedadla */
    option {
        color: green;
    }
</style>

<script>
    function aktualizovatSedadlaAndCenu(inputElement) {
        // 1. P≈òEPOƒåET CENY
        let total = 0;
        const checkedInputs = document.querySelectorAll('input[type="radio"]:checked');

        checkedInputs.forEach(input => {
            let priceStr = input.getAttribute('data-price').replace(',', '.');
            total += parseFloat(priceStr);
        });
        document.getElementById('total-price').innerText = total.toFixed(2);

        // 2. GENERUJ SEDADLA PRO TENTO KONKR√âTN√ç LET A T≈ò√çDU

        // Z√≠sk√°me ID letu a seznam obsazen√Ωch m√≠st
        let segmentContainer = inputElement.closest('.flight-segment-container');
        let letId = segmentContainer.getAttribute('data-let-id');
        let occupiedSeats = JSON.parse(segmentContainer.getAttribute('data-occupied'));

        // --- ZMƒöNA: Kapacitu nebereme z letadla, ale z konkr√©tn√≠ho invent√°≈ôe ---
        let seatCount = parseInt(inputElement.getAttribute('data-seat-count'));
        // -----------------------------------------------------------------------

        // Zjist√≠me index t≈ô√≠dy pro p√≠smeno (A, B, C...)
        let classIndex = parseInt(inputElement.getAttribute('data-class-index'));
        let prefix = String.fromCharCode(64 + classIndex);

        // Najdeme a vyƒçist√≠me select box
        let selectBox = document.getElementById('sedadlo-select-' + letId);
        selectBox.innerHTML = '<option value="">-- Vyberte sedadlo --</option>';
        selectBox.disabled = false;

        // Generujeme sedadla
        let seatsInRow = ['A', 'B', 'C', 'D', 'E', 'F'];

        // Spoƒç√≠t√°me pot≈ôebn√Ω poƒçet ≈ôad (nap≈ô. 20 m√≠st / 6 = 4 ≈ôady)
        let rows = Math.ceil(seatCount / 6);

        let seatsGenerated = 0; // Poƒç√≠tadlo vygenerovan√Ωch sedadel

        for (let r = 1; r <= rows; r++) {
            for (let s = 0; s < seatsInRow.length; s++) {

                // --- ZMƒöNA: Pokud jsme dos√°hli limitu pro tuto t≈ô√≠du, konƒç√≠me ---
                if (seatsGenerated >= seatCount) {
                    break;
                }
                // ----------------------------------------------------------------

                let seatCode = prefix + r + seatsInRow[s]; // Nap≈ô. A1A

                let option = document.createElement('option');
                option.value = seatCode;

                if (occupiedSeats.includes(seatCode)) {
                    option.text = "‚ùå " + seatCode + " (Obsazeno)";
                    option.disabled = true;
                } else {
                    option.text = "‚úÖ " + seatCode + " (Voln√©)";
                }

                selectBox.add(option);
                seatsGenerated++; // Zv√Ω≈°√≠me poƒç√≠tadlo
            }
        }
    }
</script>

{% endblock %}